### 负载均衡

#### 负载均衡

##### Q1. 什么是负载均衡？原理是什么？
负载均衡（Load Balance），意思是将负载（工作任务，访问请求）进行平衡、分摊到多个操作单元（服务器，组件）上进行执行。是解决高性能，单点故障（高可用），扩展性（水平伸缩）的终极解决方案。

1. 负载均衡原理: 采用横向扩展的方式，通过添加机器来满足大型网站服务的处理能力
   - 应用集群：将同一应用部署到多台机器上，组成处理集群，接收负载均衡设备分发的请求，进行处理，并返回相应数据。
   - 负载均衡设备：将用户访问的请求，根据负载均衡算法，分发到集群中的一台处理服务器。（一种把网络请求分散到一个服务器集群中的可用服务器上去的设备）
2. 负载均衡的作用（解决的问题）：
   - 1.解决并发压力，提高应用处理性能（增加吞吐量，加强网络处理能力）；
   - 2.提供故障转移，实现高可用；
   - 3.通过添加或减少服务器数量，提供网站伸缩性（扩展性）；
   - 4.安全防护；（负载均衡设备上做一些过滤，黑白名单等处理）
   
##### Q2. 负载均衡有哪些分类？
根据实现技术不同，可分为DNS负载均衡，HTTP负载均衡，IP负载均衡，链路层负载均衡等。

1. DNS负载均衡
   - 最早的负载均衡技术，利用域名解析实现负载均衡，在DNS服务器，配置多个A记录，这些A记录对应的服务器构成集群。大型网站总是部分使用DNS解析，作为第一级负载均衡
   - 将DNS作为第一级负载均衡，A记录对应着内部负载均衡的IP地址，通过内部负载均衡将请求分发到真实的Web服务器上。一般用于互联网公司，复杂的业务系统不合适使用
2. IP负载均衡
   - 在网络层通过修改请求目标地址进行负载均衡。
   - 用户请求数据包，到达负载均衡服务器后，负载均衡服务器在操作系统内核进程获取网络数据包，根据负载均衡算法得到一台真实服务器地址，然后将请求目的地址修改为，获得的真实ip地址，不需要经过用户进程处理。
   - 真实服务器处理完成后，响应数据包回到负载均衡服务器，负载均衡服务器，再将数据包源地址修改为自身的ip地址，发送给用户浏览器
   - IP负载均衡，真实物理服务器返回给负载均衡服务器，存在两种方式
     - （1）负载均衡服务器在修改目的ip地址的同时修改源地址。将数据包源地址设为自身盘，即源地址转换（snat）。
     - （2）将负载均衡服务器同时作为真实物理服务器集群的网关服务器。
3. 链路层负载均衡
   - 在通信协议的数据链路层修改mac地址，进行负载均衡。
   - 数据分发时，不修改ip地址，指修改目标mac地址，配置真实物理服务器集群所有机器虚拟ip和负载均衡服务器ip地址一致，达到不修改数据包的源地址和目标地址，进行数据分发的目的。
   - 实际处理服务器ip和数据请求目的ip一致，不需要经过负载均衡服务器进行地址转换，可将响应数据包直接返回给用户浏览器，避免负载均衡服务器网卡带宽成为瓶颈。也称为直接路由模式（DR模式）
   - 实践建议：DR模式是目前使用最广泛的一种负载均衡方式。
4. 混合型负载均衡
   - 由于多个服务器群内硬件设备、各自的规模、提供的服务等的差异，可以考虑给每个服务器群采用最合适的负载均衡方式，然后又在这多个服务器群间再一次负载均衡或群集起来以一个整体向外界提供服务（即把这多个服务器群当做一个新的服务器群），从而达到最佳的性能
   - 将这种方式称之为混合型负载均衡。
   - 此种方式有时也用于单台均衡设备的性能不能满足大量连接请求的情况下。是目前大型互联网公司，普遍使用的方式。

##### Q3. 常见的负载均衡服务器有哪些？
平时我们常用的有四层负载均衡和七层负载均衡，四层的负载均衡是基于IP和端口实现的，七层的负载均衡是在四层的基础上，基于URL等信息实现。

1. 四层负载均衡
   - LVS：重量级软件，本身不支持正则表达式，部署起来比较麻烦，但是性能高，应用范围广，一般的大型互联网公司都有用到。
   - HAProxy：轻量级软件，支持的负载均衡策略非常多，较灵活。
   - Nginx：轻量级软件，支持的协议少（HTTP、HTTPS和Email协议），对于Session支持不友好。
2. 七层负载均衡
   - HAProxy：全面支持七层代理，灵活性高，支持Session会话保持。
   - Nginx：可以针对HTTP应用进行分流，正则规则灵活，支持高并发，部署简单。
   - Apache：性能较差，一般不考虑。
   - MySQL Proxy：官方的数据库中间件，可以实现读写分离，负载均衡等功能，但是对分表分库支持不完善（可选替代品：Atlas，Cobar，TDDL）。

##### Q4. 常见的负载均衡的算法？
1. 第一类，轮询法
   - 轮询法
     - 将请求按顺序轮流地分配到后端服务器上，它均衡地对待后端的每一台服务器，而不关心服务器实际的连接数和当前的系统负载。
   - 加权轮询法(Weight Round Robin)
     - 不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。
     - 给配置高、负载低的机器配置更高的权重，让其处理更多的请；而配置低、负载高的机器，给其分配较低的权重，降低其系统负载
     - 加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。
2. 随机法
   - 随机法(Random)
     - 通过系统的随机算法，根据后端服务器的列表大小值来随机选取其中的一台服务器进行访问。由概率统计理论可以得知，随着客户端调用服务端的次数增多， 其实际效果越来越接近于平均分配调用量到后端的每一台服务器，也就是轮询的结果。
   - 加权随机法(Weight Random)
     - 与加权轮询法一样，加权随机法也根据后端机器的配置，系统的负载分配不同的权重。不同的是，它是按照权重随机请求后端服务器，而非顺序。 
3. 哈希
   - 源地址哈希法(Hash)
     - 源地址哈希的思想是根据获取客户端的IP地址，通过哈希函数计算得到的一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客服端要访问服务器的序号
     - 采用源地址哈希法进行负载均衡，同一IP地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问。
4. 连接数法
   - 最小连接数法(Least Connections)
     - 最小连接数算法比较灵活和智能，由于后端服务器的配置不尽相同，对于请求的处理有快有慢，它是根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器

#### 灾备和故障转移

##### Q1. 什么是容灾？一般基于什么实现？
容灾是指为了保证关键业务和应用在经历各种灾难后，仍然能够最大限度的提供正常服务的所进行的一系列系统计划及建设和管理行为。

容灾能力基于数据复制和故障转移。

##### Q2. 一般怎么实现灾备？
备份是对数据进行保护，容灾是在备份的基础上，保障企业的业务连续性，从这个层面，一般将容灾划分为数据容灾和应用容灾。

数据容灾是指建立一个异地的数据系统，该系统是本地关键应用数据的一个实时复制。

应用容灾是指在数据容灾的基础上，在异地建立一套完整的与本地生产系统相当的备份应用系统，在灾难发生时，备端系统迅速接管业务继续运行。